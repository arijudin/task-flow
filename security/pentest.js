const { spawn } = require("child_process")
const fs = require("fs")
const path = require("path")

// Path to save the report
const reportPath = path.join(process.cwd(), "security-reports", "pentest-report.html")

// Ensure the reports directory exists
if (!fs.existsSync(path.join(process.cwd(), "security-reports"))) {
  fs.mkdirSync(path.join(process.cwd(), "security-reports"), { recursive: true })
}

// Start the application
const app = spawn("npm", ["run", "dev"])

// Wait for the app to start
setTimeout(() => {
  console.log("Starting penetration test...")

  // Run OWASP ZAP full scan
  // This assumes ZAP is installed and available in PATH
  // For CI environments, you would use a Docker container
  const zap = spawn("zap-cli", [
    "active-scan",
    "--scanners",
    "all",
    "--recursive",
    "--spider",
    "--ajax-spider",
    "--start-options",
    "-config api.disablekey=true",
    "-r",
    reportPath,
    "http://localhost:3000",
  ])

  zap.stdout.on("data", (data) => {
    console.log(`ZAP: ${data}`)
  })

  zap.stderr.on("data", (data) => {
    console.error(`ZAP Error: ${data}`)
  })

  zap.on("close", (code) => {
    console.log(`ZAP scan completed with code ${code}`)

    // Stop the application
    app.kill()
    process.exit(code)
  })
}, 10000) // Wait 10 seconds for the app to start

app.stdout.on("data", (data) => {
  console.log(`App: ${data}`)
})

app.stderr.on("data", (data) => {
  console.error(`App Error: ${data}`)
})
